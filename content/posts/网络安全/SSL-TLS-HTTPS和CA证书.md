---
title: SSL-TLS-HTTPS和CA证书
date: 2021-01-14
categories: [网络安全]
tags: [SSL\TLS,HTTPS,网络]
---

## 对称加密

**对称加密**就是在两端通信的时候使用**同一个密钥**进行加密解密，

特点：

- 不够安全，密钥如何传的问题（由非对称加密解决）
- 加解密的CPU消耗低

相关算法：`DES、AES`

本质就是将 **密钥+数据** 进过一个公式或则运算获得密文，对方也用 **密钥+密文** 进过一个公式或运算能还原回数据，下面展示最简单的 **XOR对称加密**:

现在有密钥: `1111`   待加密的密文: `1010`

```bash
第一次XOR: 1010^1111=0101
第二次XOR: 0101^1111=1010
```

可以看到进过两次XOR运算又回去了，因此就可以利用此特性进行对称加密
但是要加密的信息往往比密钥长，密钥一般很短，那么就需要将数据进行分组，每组长度就是密钥的长度，然后分别对每组进行XOR运算，最后拼接

比如现在A用密钥进行加密(XOR运算)了，B收到加密的密文之后还是用相同的密钥进行XOR运算，这样就可以解密了

​    

## 非对称加密

**非对称加密**就是使用不同的密钥进行加密解密，比如使用 **公钥** 加密，使用 **私钥 **解密

特点：

- 安全，解决了 **对称加密** 密钥传输问题
- 加解密CPU消耗高，需要复杂的数学运算

> **所以一般使用非对称加密进行传输对称加密密钥，之后用对称加密进行通信**

相关算法：`RSA、ECC`

非对称加密就是将 **公钥+数据** 进过一个公式进行处理就变成一个密文，然后对方用 **私钥+密文** 也进过一个公式处理就变成了原始数据，反之同理

​    

## 信息摘要

**摘要**主要是为了 **防止信息被篡改** ，又称为 **信息指纹** ，并且通过摘要算法之后可以讲不同长度的数据都变为固定长度的hash字符串

字符串、文件等内容经过 **摘要算法(hash算法)** 进行hash散列之后得到的一串固定长度的 **hash字符串** 这就是 **信息摘要** 

摘要算法其实是一种 **单向的加密算法** ，只能加密而不能解密，也就是说不能通过hash字符串推出原来的数据

常见的hash算法有：`MD5、SHA256`

​    

## 数字签名

数字签名和真实世界的签名一样，使用公钥加密私钥解密，目的有两个:

- 验证这段信息是对方发出来的，防止信息被替换，因为一旦被替换了那么我们用原来的公钥就无法解密了，以此就可以认定信息不是原公钥所有者发送的
- 加密信息，防止信息被篡改。通常中间人想要篡改信息体那么就必须连同摘要也一并篡改。比如用公钥加密信息摘要，那么中间人一旦篡改摘要那么中间人就必须使用发送者的私钥进行再次加密才可以保证自己的篡改不会被发现。如果中间人拿自己的私钥再次签名的话接受者就无法通过原来的公钥解密了

下面举例证实案例:

- A：用自己的A私钥对摘要进行加密，加密后的摘要就叫数字签名
- B：用A公钥对数字签名进行解密得到摘要，只要能够解密签名则可以证明这个信息就是公钥所属者发的
- B：拿到摘要之后再用相同的信息摘要算法对消息体计算摘要，对比两个摘要是否相同就可以验证消息体是否被篡改

验证数字签名的前提是要拿到对方的公钥，但是公钥在传输过程中可能会被中间人，所以需要通过CA证书证明公钥是否属于对方，而CA证书的信息是被CA私钥加密过的，我们只需要用CA公钥进行解密即可拿到公钥，因为中间人没有CA的私钥所以无法篡改伪造证书内容，一旦篡改就会被发现

​    

## CA证书

### 1、公钥的作用

为了给对方发送消息不被别人截获泄露，我们需要使用对方的公钥加密信息，这样只有私钥持有者才可以解密信息

### 2、CA证书

**CA证书**类似于身份证，用来**证明公钥的正确性**，证明对方发来的公钥是否属于对方，就比如公安局给公民发放身份证来证明这个人就是你

想象一下如果不验证公钥的正确性的话: 

- A给B发送自己的公钥时被C给中间人了
- C劫持A的公钥并替换为C的公钥发给B
- B以为是A的公钥，则继续用C的公钥通信，
- 那么C就可以劫持所有B给A发送的消息

所以为了防止 **中间人攻击**，需要借助有权威值得信任的第三方来传递自己的公钥，因此为了验证发来的公钥是否被劫持是否属于对方，那么就需要一个**第三方权威机构**颁发一个**CA证书**来证明身份，并且在证书上会附带自己的公钥

这里要注意，中间人因为没有CA的私钥，是不可能伪造一个证书的，底一级的CA也是需要向上一级更加权威的CA申请证书来证明自己，当到了根CA，就需要自己证明自己了，这就是 **自签证书**  根CA必须具备非常好的权威和信任力，并且能保证自己的私钥绝对不会泄露

如果对方发了一个自签的证书并且不是根CA的就会被判定不安全证书，可能是中间人自己签发的证书，没有任何权威机构的保障

### 3、CA证书组成

1. 颁发者(证书的发布机构)
2. 有效期从, 到 (证书的有效期)
3. **证书持有者的公钥**
4. 证书持有者信息
5. 摘要算法（对证书生成 **摘要**的算法 ）
6. **证书本身的摘要** （防止证书被篡改）
7. 签名算法（对证书摘要签名的算法）
8. **证书的CA签名**    

### 4、证书签名和验证过程

1. CA生成证书
    - 对证书颁发者信息、证书持有者信息、证书有效期、**证书持有者公钥**等信息并生成**证书摘要**，将摘要附着在证书上
    - CA用自己的私钥对 **证书摘要** 进行签名，并将 **证书签名**附着在证书上，这时这个证书就是进过CA签名过的合法证书，相对于给证书盖个章吧
    - CA将签过名的证书发给证书拥有者
2. 发送者A发送自己的证书
    - A要给B发消息要先发送自己的证书，证明这个是自己
    - 这时就不会遭受**中间人攻击**了，因为中间人没有CA的私钥，无法伪造签名

3. 接受者验证证书并且获得A的公钥
    - B通过某种途径（如浏览器访问）拿到签过名的数字证书
    - B使用CA公钥解密 **签名**，得到 **证书摘要**，然后对证书用相同 **摘要算法** 计算摘要，对比两个摘要是否相同，相同则证明证书信息没有被篡改，然后从证书中获取**A的公钥**

### 5、CA证书信任链

那么如何保证CA的公钥是属于CA自己的呢？这就涉及到证书调用链的过程

小一点的 CA 可以让大 CA 签名认证，但链条的最后，也就是**Root CA**，就只能自己证明自己了，这个就叫**自签名证书** `Self-Signed Certificate` 或者**根证书**`Root Certificate`

<img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/81c813f84a264ca1addceb470cbd77bf~tplv-k3u1fbpfcp-watermark.image" style="zoom:50%;" />

​    

​    

## SSL/TLS协议和HTTPS

![img](https://user-gold-cdn.xitu.io/2019/9/9/16d1385e7286a6a4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

`HTTP`通讯只需要建立`TCP`连接即可

`HTTPS`通讯之前双方在建立`TCP`连接之后还需要建立`SSL/TLS`连接，在`SSL/TLS`之上进行通讯的`HTTP`协议就叫`HTTPS` ，所以 `HTTPS=HTTP+SSL/TLS`

**SSL/TLS建立连接交换密钥的过程：**

![在这里插入图片描述](https://user-gold-cdn.xitu.io/2020/4/29/171c19d411a7eacb?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

​    

1. 客户端给出 
    - `SSL/TLS`协议的版本号
    - 随机数 `R1`
    - 客户端支持的非对称加密算法`RSA、ECC`等
2. 服务器端返回
    - 使用的加密算法
    - 数字证书
    - 随机数`R2`
3. 客户端认证证书有效性，是否被篡改等，如果证书有效则：
    - 生成随机数 `R3`
    - 用证书中的公钥（也就是服务器的公钥）加密`R3` 并发送回去
4. 服务器用自己的私钥解密 `R3`，此时双方持有 `R1、R2、R3` 3个随机数，其中 `R3`是经过非对称加密的，不可能被外界获取
5. 然后双方就使用相同的方法结合3个随机数生成 **对称加密密钥** ，这就完成了对称加密密钥的传输，之后就可以使用对称加密进行传输数据了

SSL连接建立交换对称密钥之后，相当于建立了一个虚拟通道，之后所有的应用层数据比如HTTP协议传递下来的所有数据(包括HTTP头部信息)  一律进过SSL层的对称密钥进行加密，传输到客户端浏览器之后就会进行解密这样才能分析出HTTP头部和信息部分  

​    

## 参考

http://www.ruanyifeng.com/blog/2011/08/what_is_a_digital_signature.html

https://juejin.cn/post/6844903638117122056#heading-21

https://www.bilibili.com/video/BV1KV41187ko?p=3

https://juejin.cn/post/6844903937938554888

https://juejin.cn/post/6844904148719124488#heading-1

http://www.ruanyifeng.com/blog/2017/05/xor.html 【XOR对称加密】

http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html 【SSL握手】
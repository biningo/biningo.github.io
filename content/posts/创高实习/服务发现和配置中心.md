---
title: 服务发现和配置中心
date: 2021-07-12
categories: [创高实习]
draft: true
---

## 我的任务

- **服务发现**
- **配置中心**
- 熔断和回退
- 负载均衡

​      

## 为什么需要服务注册

> **服务太多、IP和Port无法确定**

微服务架构下，通过Docker容器进行部署，使用k8s进行容器排编来达到容器分布式和容器集群资源管理

- 容器是进程模型，是非常轻量级的，可能容器挂了又重启之后IP就变化了，所以IP不能保证前后都是一样的

- 同时Docker容器暴露出来的端口最好由Docker进行随机映射，否则如果服务数量多起来之后并且没有很好的规划的则容易造成端口冲突，这样会造成不必要麻烦

综上，我们的微服务之间调用就无法准确的知道其它服务的**IP地址和端口**，只能通过服务名字来进行调用

总结几点服务注册中心的作用

- **服务发现**  通过服务名字找到服务对应的`IP+Port`再进行HTTP调用服务

- **解耦**  引入第三方组件，解耦多个模块和服务，这样就不需要在各个服务中硬编码了，所有服务都去注册中心查找其他服务（思想类似于消息队列解耦）
- **健康检查**  服务健康状况报告(一个服务可能部署多份，所以需要准确的知道服务正则运行的实例数量)
- **负载均衡**(可以在服务注册中心中实现，比如客户端到注册中心查找服务，注册中心根据指定的负载均衡策略返回IP给客户端，然后客户端再进行调用)

因为服务注册是一个项目中最核心的部分(就如k8s中的api-server组件那样核心)，一个微服务挂了也只会造成其对应模块的影响，但是一旦注册中心挂了那么整个微服务项目就挂了，所以必须保证服务注册组件的高可用，所以技术选型上必须选择**分布式(Raft一致性算法)、开源时间久、广泛应用**的开源组件

​       

## 为什么需要配置中心

- 服务拆分之后配置也会变多，微服务下每一个服务都有自己的配置

- 配置统一管理

​       

## 注册中心分类

- **Consul** (go、kv、服务发现)
- **Etcd**  (go、kv、k8s核心存储组件，可靠性高)

- ~~Nacos (Java) 阿里开源，属于Java和Spring生态，go API库缺乏，功能非常丰富~~
- ~~Eureka (停止更新，只维护老版本不再开发新版本)~~
- ~~Zookeeper(kv) 不需要考虑，因为有更好的可代替组件Etcd~~
- ~~Nginx代理服务，硬编码注册服务，只需要配置相关的URL路径和后端地址即可代理到URL对应的服务上，运维工作量大~~

​      

## Consul (kɑːnsl康手)

> Consul特点

1. 服务发现
2. 健康检查
3. K/V存储
4. 支持HTTP、DNS协议访问
5. 自带web监控界面
6. 分布式，CP模式集群
7. 结合`fabio`实现负载均衡

> Consul背景

Consul是hashicorp团队开发的（vagrant开发团队）

> Consul官方文档

[https://www.consul.io/docs](https://www.consul.io/docs)

​      

## Etcd

- Raft一致性算法，自带分布式
- k8s最核心分布式存储组件
- go语言编写

​     

## 配置中心

- **Apollo** (Java 携程开源)太过复杂，功能冗余，属于Java生态，goAPI不完善
- Etcd
- Consul

​     

## 负载均衡

> TODO

在同一个服务需要部署多份的时候才需要进行负载均衡，负载均衡有以下几个方式

1. 代理负载均衡，比如Nginx
2. 客户端自己去注册中心获取服务的IP地址，然后在客户端进行负载均衡

开源组件

- fabio (go)，ebay开源的负载均衡组件

​      

## 我的想法

完全使用go生态，防止不必要的麻烦

`consul+fabio` 服务发现+负载均衡+配置中心(kv数据库)

`etcd` 也可，需要自己写

​     

## 参考链接

[微服务为什么要有服务发现与注册？](https://xie.infoq.cn/article/13a6973621381b27bbcd9ab45)

[Understandable Distributed Consensus](http://thesecretlivesofdata.com/raft/)

[容易理解的Distributed Consensus分布式共识算法](http://www.kailing.pub/raft/index.html)

[hashicorp](https://github.com/hashicorp)


---
title: 数据链路层和以太网
date: 2021-03-04
categories: [网络]
tags: [网络协议,以太网]
---

## 局域网和以太网的区别

局域网需要解决的就是网内多对多的通讯，局域网内所有的主机都可以进行通讯，一个简单粗暴的办法就是给每台PC都连接到网内任何一台PC的网线这不现实，每加入一台PC就需要给网内的每台PC加一条网线太不现实了，所以就需要一些 **局域网拓扑结构** 来解决这个问题

局域网拓扑结构有很多种，有星型、环形、总线型等，大多数的局域网都是 **星型** 局域网内的主机都连接到比如 **集线器** 的物理设备中进行通讯，所有信息都经过集线器然后再进行转发，这样局域网内的主机就可以和网内所有的主机进行通讯了，这种 **星型** 类型的局域网叫做 **以太网** 

**综上: 以太网是一种局域网**

​    

## MAC地址

```txt
24:41:8c:28:e2:ea
```

MAC地址由`:`分割，每个单元都由一个`16`进制表示，大小为`8`byte，MAC地址是全球唯一的

前 24 位是设备制造商的标识符，由`IEEE`组织分配，也就是组织唯一标识符，后24位由设备制造商自己内部分配，必须要保证唯一

​    

## 数据链路层

数据链路层需要将上层 **网络层** 传递下来的 **IP数据报** 封装层帧（也就是加上一些报头和报尾）然后将数据帧在 **局域网/以太网** 中传播，在数据链路层/以太网中 **MAC地址** 唯一标识一台网络设备

> 为什么有了IP还需要MAC ? 为什么有了MAC还需要IP?

现在基本的局域网都是 **以太网** ，所以最常见的链路层的数据帧是 **Enthernet || 格式**

的数据帧，也叫 **MAC帧** (因为该帧的特点是通过MAC地址进行通讯)

链路层主要有两种类型的信道: 

- 1对1信道，比如 **PPP协议**
- 广播信道，比如以太网

链路层主要解决下列3个问题:

- **封装成帧**: 比如 **Ehthernet || 数据帧** ，并且需要对一些特殊字符(比如报文信息中出现了和数据帧控制字符一样的字节)进行转义处理，并且需要加入一些头部控制信息，比如目标的MAC地址和源地址，以及数据帧内容的类型，是IP数据报还是ARP报文、ICMP报文等其他类型的数据帧
- **差错检测**: 如果数据帧在传输过程被干扰出现错误，那么就需要丢弃这个数据帧，所以在接受到之前需要进行检测
- **透明传输:** 因为之前插入了一些转义处理的字节，所以在接受到时需要去除这些冗余的字节，这些多余的字节必须不影响原来数据包的传播，看起来就像是透明的

​    

## Ehthernet ||帧格式

没有`VLAN`的格式

![](https://raw.githubusercontent.com/biningo/cdn/master/img1/enthernet2.png)

有`VLAN`格式

![](https://raw.githubusercontent.com/biningo/cdn/master/img1/vlan.png)

| 字段             | 大小(byte) | 含义                                                         |
| ---------------- | ---------- | ------------------------------------------------------------ |
| 目的地址和源地址 | 分别为6    | 都是MAC地址 (目的地址可能是FF，这是一个广播地址)             |
| VLAN标记         | 4          | VLAN的相关信息                                               |
| 类型Type         | 2          | 表示数据是什么类型的数据报，比如 IPv4、IPv6数据报、ARP数据报、ICMP数据报等 |
| 数据             | 46~1500    | 封装网络层的数据报，这里有个最大值，不同的以太网不同，这个最大值叫 **MTU(Maximum Transmission Unit)**最大传输单元，一般为`1500`，如果上层的数据报超过了这个值就会被拆分为多个数据帧 |
| 帧检验序列FCS    | 4          | 用于检验帧是否出现差错，如果出现错误则会丢弃这个帧           |

`VLAN`标签各字段含义

| 字段 | 长度  | 含义                                                         | 取值                                                         |
| ---- | ----- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| TPID | 2Byte | Tag Protocol Identifier（标签协议标识符），表示数据帧类型。  | 取值为0x8100时表示IEEE 802.1Q的VLAN数据帧。如果不支持802.1Q的设备收到这样的帧，会将其丢弃。各设备厂商可以自定义该字段的值。当邻居设备将TPID值配置为非0x8100时， 为了能够识别这样的报文，实现互通，必须在本设备上修改TPID值，确保和邻居设备的TPID值配置一致。 |
| PRI  | 3bit  | Priority，表示数据帧的802.1p优先级。                         | 取值范围为0～7，值越大优先级越高。当网络阻塞时，交换机优先发送优先级高的数据帧。 |
| CFI  | 1bit  | Canonical Format Indicator（标准格式指示位），表示MAC地址在不同的传输介质中是否以标准格式进行封装，用于兼容以太网和令牌环网。 | CFI取值为0表示MAC地址以标准格式进行封装，为1表示以非标准格式封装。在以太网中，CFI的值为0。 |
| VID  | 12bit | VLAN ID，表示该数据帧所属VLAN的编号。                        | VLAN ID取值范围是0～4095。由于0和4095为协议保留取值，所以VLAN ID的有效取值范围是1～4094 |

> `Virtual LAN` 虚拟局域网，将一个局域网通过交换机等设备分割为多个小型的子网，将一个大的广播域分割为多个小的广播域，这就叫 **VLAN** 
>
> 广播域: 一个广播包能到达的所有地方组成一个广播域

> `WireShark` 无法抓取以太 **帧前序** 和`FCS`原因:
>
> 因为WireShark将这两个部分给过滤了，这两个部分用来标识一个以太网数据帧，所以会被过滤

​    

## 数据链路层的物理设备

**物理层设备(一层设备)**

只能单纯的转发01比特流

-  **集线器**
- **中继器**

**数据链路层设备(二层设备)**

能分析出MAC数据帧，并且能获取数据帧的信息，目标MAC地址等，并且能进行差错检测

- **网桥**
- **交换机** (交换机也有三层交换机,具备路由功能,能跨网段通讯)

​    

## 局域网中数据通讯过程

A主机发送一个IP数据包，首先会先用掩码与目标IP进行 **AND** 运算，判断目标IP是否属于同一个局域网中

如果属于同一个局域网中，则使用 **ARP协议** 或则查找本地 **ARP缓存** 获得MAC地址，然后封装为 **MAC帧** 通过网卡发送出去，发送到交换机中，然后交换机根据MAC和端口的映射转发到指定端口中，目标网卡会先检查一下目标MAC是否属于自己，不属于自己则丢弃

如果不属于同一个局域网则获取根据网关的MAC地址然后转发到网关中，局域网没有配置网关则发送数据包失败

​    

## 其他数据链路层协议

- PPP协议

​    

## 参考

https://medium.com/@mdlayher/network-protocol-breakdown-ethernet-and-go-de985d726cc1